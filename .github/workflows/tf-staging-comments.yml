name: Terraform PR comments (staging only)

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write

jobs:
  dispatch:
    if: |
      github.event.issue.pull_request &&
      (startsWith(github.event.comment.body, '/tf plan') || startsWith(github.event.comment.body, '/tf apply'))
    runs-on: ubuntu-latest

    outputs:
      action: ${{ steps.parse.outputs.action }}
      head_sha: ${{ steps.pr.outputs.head_sha }}
      is_fork: ${{ steps.pr.outputs.is_fork }}
      matrix: ${{ steps.targets.outputs.matrix }}
      actor_ok: ${{ steps.perms.outputs.actor_ok }}
      error: ${{ steps.targets.outputs.error }}

    steps:
      - name: Parse comment
        id: parse
        run: |
          BODY="${{ github.event.comment.body }}"
          BODY="$(echo "$BODY" | tr -s ' ')"

          if [[ "$BODY" =~ ^/tf[[:space:]]+plan($|[[:space:]].*) ]]; then
            echo "action=plan" >> $GITHUB_OUTPUT
          elif [[ "$BODY" =~ ^/tf[[:space:]]+apply($|[[:space:]].*) ]]; then
            echo "action=apply" >> $GITHUB_OUTPUT
          else
            echo "action=unknown" >> $GITHUB_OUTPUT
          fi

          ARG="$(echo "$BODY" | awk '{print $3}')"
          echo "arg=$ARG" >> $GITHUB_OUTPUT

      - name: Fetch PR details
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            core.setOutput("head_sha", pr.data.head.sha);
            core.setOutput("is_fork", String(pr.data.head.repo.fork));

      - name: Check commenter permission (write/maintain/admin required for apply)
        id: perms
        uses: actions/github-script@v7
        with:
          script: |
            const actor = context.actor;
            const { owner, repo } = context.repo;

            const perm = await github.rest.repos.getCollaboratorPermissionLevel({
              owner, repo, username: actor
            });

            const level = perm.data.permission; // admin, maintain, write, triage, read, none
            const ok = ["admin", "maintain", "write"].includes(level);
            core.setOutput("actor_ok", String(ok));

      - name: Compute target roots (staging only) - via GitHub API
        id: targets
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const body = (context.payload.comment.body || "").trim().replace(/\s+/g, " ");
            const parts = body.split(" ");
            const arg = parts[2] || "";

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Helper: build terraform root path from a file path: infra/apps/<app>/<env>
            function rootFromFilename(filename) {
              if (!filename.startsWith("infra/apps/")) return null;
              const seg = filename.split("/");
              if (seg.length < 4) return null;
              return seg.slice(0, 4).join("/");
            }

            // If user specified an app or a path: /tf plan payments  OR /tf plan infra/apps/payments/staging
            if (arg) {
              const cand = arg.startsWith("infra/apps/") ? arg : `infra/apps/${arg}/staging`;

              if (!cand.endsWith("/staging")) {
                core.setOutput("matrix", JSON.stringify({ include: [] }));
                core.setOutput("error", "Only staging is allowed. Use infra/apps/<app>/staging or '/tf plan <app>'.");
                return;
              }

              core.setOutput("matrix", JSON.stringify({ include: [{ path: cand }] }));
              return;
            }

            // Otherwise: derive from changed files in the PR
            const roots = new Set();

            let page = 1;
            const per_page = 100;

            while (true) {
              const res = await github.rest.pulls.listFiles({
                owner,
                repo,
                pull_number: prNumber,
                per_page,
                page
              });

              for (const f of res.data) {
                const r = rootFromFilename(f.filename);
                if (r && r.endsWith("/staging")) roots.add(r);
              }

              if (res.data.length < per_page) break;
              page += 1;
            }

            const include = Array.from(roots).sort().map(p => ({ path: p }));
            core.setOutput("matrix", JSON.stringify({ include }));

      - name: Comment dispatch error (if any)
        if: ${{ steps.targets.outputs.error != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const msg = "${{ steps.targets.outputs.error }}";
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `⚠️ ${msg}`
            });

      - name: Comment when nothing to run
        if: ${{ steps.targets.outputs.matrix == '{"include":[]}' }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: "ℹ️ No changed **staging** Terraform roots detected under `infra/apps/**/staging`. Use `/tf plan <app>` to force one."
            });

  terraform:
    needs: dispatch
    if: ${{ fromJson(needs.dispatch.outputs.matrix).include[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.dispatch.outputs.matrix) }}

    concurrency:
      group: tf-staging-${{ matrix.path }}
      cancel-in-progress: false

    steps:
      - name: Checkout PR head
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.dispatch.outputs.head_sha }}
          fetch-depth: 0

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Init
        run: |
          terraform -chdir=${{ matrix.path }} init -backend-config=backend.hcl

      - name: Validate
        run: |
          terraform -chdir=${{ matrix.path }} fmt -check -recursive
          terraform -chdir=${{ matrix.path }} validate

      - name: Plan
        if: ${{ needs.dispatch.outputs.action == 'plan' }}
        run: |
          terraform -chdir=${{ matrix.path }} plan -no-color | tee ${{ matrix.path }}/plan.txt

      - name: Apply (staging only)
        if: ${{ needs.dispatch.outputs.action == 'apply' }}
        run: |
          if [ "${{ needs.dispatch.outputs.is_fork }}" = "true" ]; then
            echo "Refusing apply: PR is from a fork."
            exit 1
          fi
          if [ "${{ needs.dispatch.outputs.actor_ok }}" != "true" ]; then
            echo "Refusing apply: commenter lacks write/maintain/admin permission."
            exit 1
          fi

          terraform -chdir=${{ matrix.path }} apply -auto-approve -no-color | tee ${{ matrix.path }}/apply.txt

      - name: Comment plan output on PR
        if: ${{ needs.dispatch.outputs.action == 'plan' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const prNumber = context.payload.issue.number;
            const path = "${{ matrix.path }}";
            const file = `${path}/plan.txt`;

            let out = "No plan output found.";
            if (fs.existsSync(file)) out = fs.readFileSync(file, "utf8");

            const limit = 60000;
            if (out.length > limit) out = out.slice(0, limit) + "\n...\n(truncated)";

            const body = [
              "### Terraform plan — `" + path + "`",
              "",
              "```",
              out,
              "```"
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });

      - name: Comment apply output on PR
        if: ${{ needs.dispatch.outputs.action == 'apply' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const prNumber = context.payload.issue.number;
            const path = "${{ matrix.path }}";
            const file = `${path}/apply.txt`;

            let out = "No apply output found.";
            if (fs.existsSync(file)) out = fs.readFileSync(file, "utf8");

            const limit = 60000;
            if (out.length > limit) out = out.slice(0, limit) + "\n...\n(truncated)";

            const body = [
              "### Terraform apply — `" + path + "`",
              "",
              "```",
              out,
              "```"
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });

      - name: Comment result summary on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const action = "${{ needs.dispatch.outputs.action }}";
            const path = "${{ matrix.path }}";
            const ok = "${{ job.status }}" === "success";

            const body = ok
              ? `✅ Terraform **${action}** succeeded for \`${path}\``
              : `❌ Terraform **${action}** failed for \`${path}\` (check workflow logs)`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });
